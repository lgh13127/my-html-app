name: Build Android APK (Agora Audio Call)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    env:
      # 1. 补充GRADLE_HOME定义（适配Cordova 12 + Android 33）
      GRADLE_HOME: /usr/local/gradle-7.5.1
      ANDROID_HOME: /usr/local/android-sdk
      JAVA_HOME: /usr/lib/jvm/temurin-8-jdk-amd64
      # 2. 修复PATH：移除循环引用，直接拼接绝对路径（优先系统默认路径）
      PATH: /bin:/usr/bin:/usr/local/bin:${{ env.GRADLE_HOME }}/bin:${{ env.ANDROID_HOME }}/tools:${{ env.ANDROID_HOME }}/platform-tools:${{ env.ANDROID_HOME }}/build-tools/33.0.2

    steps:
      # 兜底安装基础工具（解决tar/unzip找不到问题）
      - name: Install Basic Dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y tar unzip curl wget
          which tar && tar --version

      - name: Checkout code
        uses: actions/checkout@v4

      # 安装指定Gradle版本（匹配env里的GRADLE_HOME）
      - name: Install Gradle 7.5.1
        run: |
          sudo apt-get remove -y gradle || true
          sudo rm -rf /usr/share/gradle* || true
          wget -q https://services.gradle.org/distributions/gradle-7.5.1-bin.zip -O /tmp/gradle-7.5.1.zip
          unzip -q /tmp/gradle-7.5.1.zip -d /usr/local/
          sudo ln -sf /usr/local/gradle-7.5.1/bin/gradle /usr/bin/gradle
          gradle -v

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'

      - name: Install Cordova
        run: |
          npm install -g cordova@12.0.0
          cordova -v

      - name: Setup Java 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Install Android SDK
        run: |
          sudo mkdir -p $ANDROID_HOME && sudo chmod -R 777 $ANDROID_HOME
          curl -fsSL -o $ANDROID_HOME/sdk-tools.zip https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip
          unzip -q $ANDROID_HOME/sdk-tools.zip -d $ANDROID_HOME
          yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses > /dev/null 2>&1
          $ANDROID_HOME/tools/bin/sdkmanager \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "platform-tools" \
            "extras;android;m2repository" \
            "extras;google;m2repository" > /dev/null 2>&1

      - name: Initialize Cordova Project
        run: |
          if [ ! -f "package.json" ]; then
              cordova create . com.agora.audiocall AudioCall
          fi
          cordova platform add android@12.0.0 --save
          cordova plugin add cordova-plugin-media-capture
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-webview-plus
          # 修复权限问题
          cordova prepare android
          sudo chmod -R 777 platforms/android/
          sudo chown -R runner:runner platforms/android/
          cordova platforms list
          cordova plugins list

      # 修复CordovaLib镜像（解决依赖下载失败）
      - name: Fix CordovaLib Repository (Aliyun Mirror)
        run: |
          cd platforms/android/CordovaLib
          # 修复buildscript的repositories块
          if grep -q "buildscript {.*repositories {" build.gradle; then
              sed -i '/buildscript {.*repositories {/a \            maven { url "https://maven.aliyun.com/repository/jcenter" }' build.gradle
          elif grep -q "buildscript {" build.gradle; then
              sed -i '/buildscript {/a \    repositories {\n        maven { url "https://maven.aliyun.com/repository/jcenter" }\n        jcenter()\n        google()\n    }' build.gradle
          else
              sed -i '1i buildscript {\n    repositories {\n        maven { url "https://maven.aliyun.com/repository/jcenter" }\n        jcenter()\n        google()\n    }\n    dependencies {\n        classpath "com.android.tools.build:gradle:7.2.0"\n    }\n}' build.gradle
          fi
          # 修复普通repositories块
          if grep -q "repositories {" build.gradle; then
              sed -i '/repositories {/a \        maven { url "https://maven.aliyun.com/repository/jcenter" }' build.gradle
          else
              sed -i '/android {/i repositories {\n        maven { url "https://maven.aliyun.com/repository/jcenter" }\n        jcenter()\n        google()\n    }' build.gradle
          fi
          # 验证修改
          echo "===== CordovaLib/build.gradle 关键部分 ====="
          grep -A 15 "buildscript {" build.gradle | head -20
          grep -A 10 "repositories {" build.gradle | head -15
          echo "============================================="

      - name: Build Android APK
        run: |
          cordova build android --debug --verbose
          APK_PATH="platforms/android/app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK_PATH" ]; then
              ls -lh $APK_PATH
              echo "✅ APK构建成功！"
          else
              echo "❌ APK未找到，打印目录："
              ls -lh platforms/android/app/build/outputs/apk/ || true
              exit 1
          fi

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agora-audio-call-apk
          path: platforms/android/app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error