name: Build Android APK
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 29
          build-tools: 29.0.3
          run-sdkmanager: true

      - name: Setup Java 8 (å¿…é¡»)
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Setup Node.js 14 (å®Œç¾å…¼å®¹Cordova9)
        uses: actions/setup-node@v4
        with:
          node-version: '14'
          registry-url: https://registry.npmmirror.com/

      - name: Install Cordova 9.0.0
        run: npm install -g cordova@9.0.0

      # âœ… æ ¸å¿ƒæ ¹æ²»ï¼šçº¯å•è¡Œechoåˆ›å»ºæ‰€æœ‰æ–‡ä»¶ï¼Œæ— ä»»ä½•YAMLè¯­æ³•é£é™©
      - name: Create WWW Files (ç»å¯¹å®‰å…¨å†™æ³•)
        run: |
          mkdir -p www
          # åˆ›å»ºé€æ˜å›¾æ ‡
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/icon.png
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/splash.png
          # å•è¡Œechoåˆ›å»ºindex.html ğŸ‘‰ 100%è§„é¿æ‰€æœ‰ç‰¹æ®Šå­—ç¬¦è§£æé”™è¯¯
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>My App</title><style>body{text-align:center;padding:60px;font-size:22px;}</style></head><body><h1>Hello Android!</h1><p>Build Success âœ”ï¸</p></body></html>' > www/index.html

      - name: Create Cordova Project
        run: cordova create build com.example.myapp MyApp && cd build && cp -r ../www ./

      # âœ… å•è¡Œechoåˆ›å»ºconfig.xml åŒæ ·ç»å¯¹å®‰å…¨
      - name: Create Config.xml (ç»å¯¹å®‰å…¨å†™æ³•)
        run: |
          cd build
          echo '<?xml version="1.0" encoding="utf-8"?><widget id="com.example.myapp" version="1.0.0" xmlns="http://www.w3.org/ns/widgets"><name>MyApp</name><content src="index.html"/><preference name="android-minSdkVersion" value="21"/><preference name="android-targetSdkVersion" value="29"/><access origin="*"/></widget>' > config.xml

      # âœ… æ‰“åŒ…APK è§£å†³æ‰€æœ‰ä¸‹è½½/å…¼å®¹é—®é¢˜
      - name: Build Android APK
        run: |
          cd build
          npm install cordova-android@9.1.0 --save
          cordova platform add android@9.1.0 --nofetch
          cordova build android --debug
          cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../app-debug.apk

      # âœ… ä¸Šä¼ APKäº§ç‰©
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-debug.apk