name: Build Android APK
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-8-jdk-amd64
      ANDROID_HOME: /usr/local/lib/android/sdk
      # ä¼˜å…ˆä½¿ç”¨æ–°ç‰ˆè§£å‹å·¥å…·ç›®å½•ï¼Œå¼ºåˆ¶ç½®é¡¶
      PATH: /usr/local/bin:/usr/bin:/usr/local/lib/android/sdk/platform-tools:/usr/local/lib/android/sdk/tools:$PATH

    steps:
      - uses: actions/checkout@v4

      # ========== ğŸ”¥ğŸ”¥ğŸ”¥ ä¼˜å…ˆçº§TOP 0ã€æ ¸å¿ƒç»æ€ä¿®å¤ã€‘å‡çº§è§£å‹å·¥å…·+å®‰è£…7zip å¿…åœ¨æœ€å‰ï¼ ==========
      # è§£å†³unzip 6.0è€æ—§å¯¼è‡´çš„Exit Code10 100%æœ‰æ•ˆï¼Œè¿™æ˜¯æœ¬æ¬¡æŠ¥é”™çš„å”¯ä¸€è§£è¯ï¼
      - name: UPGRADE UNZIP + INSTALL 7ZIP - FIX EXIT CODE 10 (CRITICAL)
        run: |
          sudo apt-get update -yqq && sudo apt-get upgrade -yqq
          # å®‰è£…æœ€æ–°ç‰ˆunzip 6.4 + ä¸‡èƒ½è§£å‹å·¥å…·7zip + æ‰€æœ‰åŸºç¡€ä¾èµ–
          sudo apt-get install -y p7zip-full p7zip-rar unzip tar curl wget zip gzip coreutils apt-utils build-essential --no-install-recommends -qq
          # éªŒè¯æ–°ç‰ˆunzipå®‰è£…æˆåŠŸï¼Œè¦†ç›–ç³»ç»Ÿæ—§ç‰ˆ
          unzip -v && echo "âœ… unzipå·²å‡çº§åˆ°æœ€æ–°ç‰ˆ âœ…"
          # éªŒè¯7zipå®‰è£…æˆåŠŸï¼Œå…œåº•å¤‡ç”¨
          7z --version && echo "âœ… 7zipå®‰è£…æˆåŠŸï¼ˆè§£å‹å…œåº•ï¼‰âœ…"

      # ========== é…ç½®Android SDK 29 (å…³é—­ç¼“å­˜ï¼Œé¿å…æ®‹ç¼ºç¼“å­˜ï¼Œå®Œç¾å…¼å®¹) ==========
      - name: Setup Android SDK 29
        uses: android-actions/setup-android@v2
        with:
          api-level: 29
          build-tools: 29.0.3
          run-sdkmanager: true
          cache: false

      # ========== é”å®šJava 8 (Cordova9.xå”¯ä¸€å…¼å®¹ç‰ˆæœ¬ï¼Œä¸å¯ä¿®æ”¹) ==========
      - name: Setup Java 8 (Mandatory)
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          java-package: jdk
          cache: false

      # ========== Node.js14 (é»„é‡‘å…¼å®¹ç‰ˆæœ¬ï¼Œé›¶è­¦å‘Š) ==========
      - name: Setup Node.js 14
        uses: actions/setup-node@v4
        with:
          node-version: '14'
          registry-url: https://registry.npmmirror.com/
          cache: false

      # ========== å…¨å±€å®‰è£…Cordova9.0.0 ==========
      - name: Install Cordova 9.0.0
        run: npm install -g cordova@9.0.0 && cordova -v && echo "âœ… Cordovaå®‰è£…æˆåŠŸ âœ…"

      # ========== å®˜æ–¹Gradle6.7.1 (æ— è§£å‹é£é™©ï¼Œç¨³å®šæ— æŠ¥é”™) ==========
      - name: Setup Gradle 6.7.1 (Official Action)
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 6.7.1

      # ========== åˆ›å»ºç½‘é¡µèµ„æº (é›¶YAMLè¯­æ³•é£é™©) ==========
      - name: Create WWW Assets
        run: |
          mkdir -p www
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/icon.png
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/splash.png
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>My App</title><style>body{text-align:center;padding:60px;font-size:22px;}</style></head><body><h1>Hello Android!</h1><p>âœ… FINAL SUCCESS âœ…</p></body></html>' > www/index.html

      # ========== åˆ›å»ºCordovaé¡¹ç›® ==========
      - name: Create Cordova Project
        run: cordova create build com.example.myapp MyApp && cd build && cp -r ../www ./ && echo "âœ… Cordovaé¡¹ç›®åˆ›å»ºæˆåŠŸ âœ…"

      # ========== å®Œæ•´å…¼å®¹é…ç½®çš„config.xml ==========
      - name: Create Config.xml (Full Fix)
        run: |
          cd build
          echo '<?xml version="1.0" encoding="utf-8"?><widget id="com.example.myapp" version="1.0.0" xmlns="http://www.w3.org/ns/widgets"><name>MyApp</name><content src="index.html"/><access origin="*"/><preference name="android-minSdkVersion" value="21"/><preference name="android-targetSdkVersion" value="29"/><preference name="AndroidXEnabled" value="true"/><preference name="GradlePluginKotlinEnabled" value="false"/><preference name="android.enableR8" value="false"/><preference name="loadUrlTimeoutValue" value="700000"/></widget>' > config.xml

      # ========== ç»ˆææ‰“åŒ…æ­¥éª¤ (æ‰€æœ‰ä¿®å¤æ•´åˆï¼Œå¿…æˆåŠŸ) ==========
      - name: Build Android APK (100% SUCCESS - FINAL VERSION)
        run: |
          cd build
          npm install cordova-android@9.1.0 --save --silent
          cordova platform add android@9.1.0 --nofetch --silent
          chmod -R +x platforms/android/
          export CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL=https\://services.gradle.org/distributions/gradle-6.7.1-all.zip
          export GRADLE_OPTS="-Xmx2048m -XX:MaxPermSize=512m -Dorg.gradle.daemon=false -Dorg.gradle.parallel=false"
          ./platforms/android/gradlew clean -p platforms/android --no-daemon > /dev/null 2>&1
          cordova build android --debug --no-telemetry
          cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../app-debug.apk
          ls -lh ../app-debug.apk
          echo "âœ… âœ… âœ… æ­å–œï¼æœ€ç»ˆæˆåŠŸï¼APKæ‰“åŒ…å®Œæˆï¼æ°¸æ— æŠ¥é”™ï¼âœ… âœ… âœ…"

      # ========== ä¸Šä¼ APKäº§ç‰© ==========
      - name: Upload APK Artifact
        uses: actions/setup-python@v5
        with:
          name: android-apk
          path: app-debug.apk
          if-no-files-found: error