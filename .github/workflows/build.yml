name: Build Android APK
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GRADLE_HOME: /usr/local/gradle-5.5.1
      JAVA_HOME: /usr/lib/jvm/temurin-8-jdk-amd64
      ANDROID_HOME: /usr/local/android-sdk
      ANDROID_SDK_ROOT: /usr/local/android-sdk
      PATH: /usr/local/gradle-5.5.1/bin:/usr/local/bin:/usr/bin:/usr/local/android-sdk/tools:/usr/local/android-sdk/platform-tools:/usr/local/android-sdk/build-tools/29.0.3:/usr/lib/jvm/temurin-8-jdk-amd64/bin

    steps:
      - uses: actions/checkout@v4

      # 1. 安装Gradle 5.5.1（Cordova 9.1.0兼容版本）
      - name: Install Gradle 5.5.1
        run: |
          sudo apt-get remove -y gradle
          sudo rm -rf /usr/share/gradle*
          wget -q https://services.gradle.org/distributions/gradle-5.5.1-bin.zip -O /tmp/gradle-5.5.1.zip
          sudo unzip -q /tmp/gradle-5.5.1.zip -d /usr/local/
          sudo ln -sf /usr/local/gradle-5.5.1/bin/gradle /usr/bin/gradle
          gradle -v

      # 2. 安装Node.js 14
      - name: Install Node.js 14
        uses: actions/setup-node@v4
        with:
          node-version: 14.x

      # 3. 安装Cordova 9.0.0
      - name: Install Cordova
        run: |
          npm install -g cordova@9.0.0
          cordova -v

      # 4. 安装Android SDK 29
      - name: Install Android SDK 29
        run: |
          sudo mkdir -p $ANDROID_HOME && sudo chmod -R 777 $ANDROID_HOME
          curl -fsSL -o $ANDROID_HOME/sdk-tools.zip https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip
          unzip -o $ANDROID_HOME/sdk-tools.zip -d $ANDROID_HOME > /dev/null 2>&1
          yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses > /dev/null 2>&1
          $ANDROID_HOME/tools/bin/sdkmanager "platforms;android-29" "build-tools;29.0.3" "platform-tools" "extras;android;m2repository" "extras;google;m2repository" > /dev/null 2>&1

      # 5. 配置Java 8
      - name: Setup Java 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          java-home: ${{ env.JAVA_HOME }}

      # 6. 创建Cordova项目
      - name: Create Cordova Project
        run: |
          cordova create my-app com.example.myapp MyApp
          cd my-app
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>My App</title><style>body{text-align:center;padding:60px;font-size:24px;}</style></head><body><h1>Hello Android!</h1><p>✅ APK BUILD SUCCESS ✅</p></body></html>" > www/index.html
          cordova platform add android@9.1.0 --save
          cordova prepare android
          sudo chmod -R 777 platforms/android/
          sudo chown -R runner:runner platforms/android/

      # 7. 构建APK（核心：添加Jcenter镜像+禁用依赖注入）
      - name: Build Android APK
        run: |
          cd my-app
          cd platforms/android

          # ========== 核心修复1：修改Cordova核心脚本，禁用versioncompare注入 ==========
          # 直接删除cordova.gradle中注入该依赖的逻辑（彻底杜绝依赖引用）
          sed -i '/com.g00fy2:versioncompare:1.3.4/d' CordovaLib/cordova.gradle
          # 验证是否删除成功
          echo "===== 验证cordova.gradle是否还有versioncompare ====="
          grep -n "versioncompare" CordovaLib/cordova.gradle || echo "✅ cordova.gradle中已无versioncompare依赖"

          # ========== 核心修复2：根build.gradle - 添加阿里云Jcenter镜像 ==========
          # 1. 清空原有buildscript仓库配置
          sed -i '/buildscript {/,/}/c\buildscript {\n    repositories {\n        maven { url "https://maven.aliyun.com/repository/jcenter" }\n        mavenCentral()\n        maven { url "https://maven.aliyun.com/repository/public" }\n        maven { url "https://maven.aliyun.com/repository/google" }\n    }\n    dependencies {\n        classpath "com.android.tools.build:gradle:3.5.4"\n    }\n}' build.gradle
          # 2. 普通repositories添加Jcenter镜像
          sed -i '/repositories {/c\repositories {\n        maven { url "https://maven.aliyun.com/repository/jcenter" }\n        mavenCentral()\n        maven { url "https://maven.aliyun.com/repository/public" }\n        maven { url "https://maven.aliyun.com/repository/google" }\n    }' build.gradle

          # ========== 核心修复3：app/build.gradle - 统一仓库配置 ==========
          sed -i '/buildscript {/,/}/c\buildscript {\n    repositories {\n        maven { url "https://maven.aliyun.com/repository/jcenter" }\n        mavenCentral()\n        maven { url "https://maven.aliyun.com/repository/public" }\n        maven { url "https://maven.aliyun.com/repository/google" }\n    }\n    dependencies {\n        classpath "com.android.tools.build:gradle:3.5.4"\n    }\n}' app/build.gradle
          sed -i '/repositories {/c\repositories {\n        maven { url "https://maven.aliyun.com/repository/jcenter" }\n        mavenCentral()\n        maven { url "https://maven.aliyun.com/repository/public" }\n        maven { url "https://maven.aliyun.com/repository/google" }\n    }' app/build.gradle

          # ========== 核心修复4：CordovaLib/build.gradle ==========
          sed -i '/repositories {/c\repositories {\n        maven { url "https://maven.aliyun.com/repository/jcenter" }\n        mavenCentral()\n        maven { url "https://maven.aliyun.com/repository/public" }\n        maven { url "https://maven.aliyun.com/repository/google" }\n    }' CordovaLib/build.gradle

          # ========== 验证仓库配置 ==========
          echo "===== 根build.gradle buildscript配置 ====="
          grep -A 20 "buildscript {" build.gradle
          echo "========================================"

          # ========== 修改gradle.properties ==========
          echo "android.useAndroidX=false" >> gradle.properties
          echo "enableJetifier=false" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties

          # ========== 构建APK（强制使用Jcenter镜像） ==========
          cd ../..
          export CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL="https://services.gradle.org/distributions/gradle-5.5.1-all.zip"
          # 强制指定仓库优先级
          gradle -p platforms/android cdvBuildDebug -Dmaven.repo.local=/tmp/m2repo \
            -Dorg.gradle.project.repositories=jcenter,mavenCentral,aliyun \
            --info

      # 8. 复制并上传APK
      - name: Copy & Upload APK
        run: |
          APK_PATH="my-app/platforms/android/app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK_PATH" ]; then
              cp "$APK_PATH" app-debug.apk
              ls -lh app-debug.apk
              echo "✅✅✅ APK生成成功！路径：$(pwd)/app-debug.apk"
          else
              echo "❌ APK未找到，打印目录："
              ls -lh my-app/platforms/android/app/build/outputs/apk/ || true
              exit 1
          fi

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-debug.apk
          if-no-files-found: error