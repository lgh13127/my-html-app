name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出代码
    - uses: actions/checkout@v4
    
    # 2. 设置Java环境（使用JDK 17，因为新版Android SDK需要）
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'  # 改为17，兼容新版Android SDK
        distribution: 'temurin'
    
    # 3. 手动设置Android SDK（避免使用android-actions/setup-android）
    - name: Setup Android SDK manually
      run: |
        # 创建Android SDK目录
        mkdir -p ~/android-sdk
        
        # 下载Android Command Line Tools
        # 使用较新的版本（需要JDK 17）
        cd ~/android-sdk
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
        unzip -q commandlinetools-linux-10406996_latest.zip
        rm commandlinetools-linux-10406996_latest.zip
        
        # 设置环境变量
        echo "ANDROID_HOME=~/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=~/android-sdk" >> $GITHUB_ENV
        echo "PATH=~/android-sdk/cmdline-tools/bin:$PATH" >> $GITHUB_ENV
        
        # 验证下载
        ls -la ~/android-sdk/
    
    # 4. 接受Android许可并安装必要组件
    - name: Install Android components
      run: |
        # 接受所有许可
        yes | ~/android-sdk/cmdline-tools/bin/sdkmanager --licenses || true
        
        # 安装必要的Android组件
        ~/android-sdk/cmdline-tools/bin/sdkmanager "platforms;android-33"
        ~/android-sdk/cmdline-tools/bin/sdkmanager "build-tools;33.0.0"
        ~/android-sdk/cmdline-tools/bin/sdkmanager "platform-tools"
        
        # 验证安装
        ~/android-sdk/cmdline-tools/bin/sdkmanager --list
    
    # 5. 安装Node.js和Cordova
    - name: Setup Node.js and Cordova
      run: |
        # 安装Node.js
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
        
        # 安装Cordova
        sudo npm install -g cordova@11.1.0
        
        # 验证安装
        echo "Cordova版本: $(cordova --version)"
        echo "Node.js版本: $(node --version)"
    
    # 6. 创建和构建Cordova项目
    - name: Build Cordova App
      run: |
        # 创建项目 - 修改包名和应用名！
        cordova create build com.lgh13127.myapp "My HTML App"
        cd build
        
        # 复制网页文件
        cp -r ../www .
        
        # 复制配置文件（可选）
        if [ -f ../config.xml ]; then
          cp ../config.xml .
        else
          # 创建基本的config.xml
          echo '<?xml version="1.0" encoding="utf-8"?>' > config.xml
          echo '<widget id="com.lgh13127.myapp" version="1.0.0" xmlns="http://www.w3.org/ns/widgets">' >> config.xml
          echo '  <name>My HTML App</name>' >> config.xml
          echo '  <description>A sample HTML app</description>' >> config.xml
          echo '  <author email="you@example.com" href="https://example.com">Your Name</author>' >> config.xml
          echo '  <content src="index.html" />' >> config.xml
          echo '  <access origin="*" />' >> config.xml
          echo '  <allow-intent href="http://*/*" />' >> config.xml
          echo '  <allow-intent href="https://*/*" />' >> config.xml
          echo '  <allow-intent href="tel:*" />' >> config.xml
          echo '  <allow-intent href="sms:*" />' >> config.xml
          echo '  <allow-intent href="mailto:*" />' >> config.xml
          echo '  <allow-intent href="geo:*" />' >> config.xml
          echo '</widget>' >> config.xml
        fi
        
        # 添加Android平台
        cordova platform add android
        
        # 构建APK
        echo "开始构建APK..."
        cordova build android --release
        
        # 复制APK到根目录
        cp platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk ../myapp-release.apk
        
        # 显示APK信息
        echo "APK文件已生成:"
        ls -lh ../myapp-release.apk
    
    # 7. 上传构建产物
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: myapp-release.apk
        if-no-files-found: error