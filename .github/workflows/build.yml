name: Build Android APK
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-8-jdk-amd64
      ANDROID_HOME: /usr/local/android-sdk
      ANDROID_SDK_ROOT: /usr/local/android-sdk
      PATH: /usr/local/bin:/usr/bin:/usr/local/android-sdk/tools:/usr/local/android-sdk/platform-tools:/usr/local/android-sdk/build-tools/29.0.3:$JAVA_HOME/bin:$PATH

    steps:
      - uses: actions/checkout@v4

      # ========== 1. å®‰è£…æ‰€æœ‰ä¾èµ– + Gradle 5.6.4 (å®Œç¾å…¼å®¹ç‰ˆ) ==========
      - name: Install All Dependencies + Gradle 5.6.4
        run: |
          sudo apt-get remove -y gradle* || true
          sudo apt-get purge -y gradle* || true
          sudo rm -rf /usr/share/gradle* /usr/local/gradle* /usr/bin/gradle || true
          sudo apt-get update -yqq && sudo apt-get upgrade -yqq
          sudo apt-get install -y p7zip-full unzip tar curl wget zip build-essential gcc-multilib lib32z1 lib32stdc++6 openjdk-8-jdk --no-install-recommends -qq
          wget -q https://services.gradle.org/distributions/gradle-5.6.4-bin.zip
          sudo unzip -q gradle-5.6.4-bin.zip -d /usr/local/
          sudo ln -sf /usr/local/gradle-5.6.4/bin/gradle /usr/bin/gradle
          GRADLE_HOME=/usr/local/gradle-5.6.4
          echo "export PATH=$GRADLE_HOME/bin:\$PATH" >> ~/.bashrc
          echo "export GRADLE_HOME=$GRADLE_HOME" >> ~/.bashrc
          source ~/.bashrc
          gradle -v
          java -version
          echo "âœ… Gradle5.6.4 + Java8 å®‰è£…æˆåŠŸ âœ…"

      # ========== 2. å®‰è£…Node14.21.3+NPM6 ==========
      - name: Install Node.js14 + NPM6
        run: |
          wget -q https://nodejs.org/dist/v14.21.3/node-v14.21.3-linux-x64.tar.xz
          sudo tar -xJf node-v14.21.3-linux-x64.tar.xz -C /usr/local/
          NODE_HOME=/usr/local/node-v14.21.3-linux-x64
          echo "export PATH=$NODE_HOME/bin:\$PATH" >> ~/.bashrc
          source ~/.bashrc
          sudo ln -sf $NODE_HOME/bin/node /usr/local/bin/node
          sudo ln -sf $NODE_HOME/bin/npm /usr/local/bin/npm
          node -v && npm -v
          npm config set registry https://registry.npmmirror.com/
          echo "âœ… Node14+NPM6 å®‰è£…æˆåŠŸ âœ…"

      # ========== 3. å®‰è£…Cordova9.0.0 ==========
      - name: Install Cordova9.0.0
        run: |
          NODE_HOME=/usr/local/node-v14.21.3-linux-x64
          npm install -g cordova@9.0.0 --unsafe-perm=true --allow-root
          sudo ln -sf $NODE_HOME/bin/cordova /usr/local/bin/cordova
          cordova -v
          echo "âœ… Cordova9.0.0 å®‰è£…æˆåŠŸ âœ…"

      # ========== 4. å®‰è£…Android SDK 29 + BuildTools 29.0.3 ==========
      - name: Install Android SDK 29 & BuildTools 29.0.3
        run: |
          sudo mkdir -p $ANDROID_HOME && sudo chmod -R 777 $ANDROID_HOME
          curl -fsSL -o $ANDROID_HOME/sdk-tools.zip https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip
          unzip -o $ANDROID_HOME/sdk-tools.zip -d $ANDROID_HOME > /dev/null 2>&1
          yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses > /dev/null 2>&1
          $ANDROID_HOME/tools/bin/sdkmanager "platforms;android-29" "build-tools;29.0.3" "platform-tools" > /dev/null 2>&1
          sudo chmod -R +x $ANDROID_HOME/tools/
          sudo chmod -R +x $ANDROID_HOME/build-tools/
          echo "âœ… Android SDK29 + BuildTools29.0.3 å®‰è£…æˆåŠŸ âœ…"

      # ========== 5. é…ç½®Java 8 ==========
      - name: Setup Java 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      # ========== 6. åˆ›å»ºé¡¹ç›®å’Œç½‘é¡µæ–‡ä»¶ ==========
      - name: Create Project & WWW Files
        run: |
          mkdir -p www
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/icon.png
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/splash.png
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>My App</title><style>body{text-align:center;padding:60px;font-size:24px;}</style></head><body><h1>Hello Android!</h1><p>âœ… APK BUILD SUCCESS âœ…</p></body></html>" > www/index.html
          cordova create build com.example.myapp MyApp && cd build && cp -r ../www ./
          echo "âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸ âœ…"

      # ========== 7. åˆ›å»ºconfig.xml (Target SDK 29) ==========
      - name: Create Config.xml (Target SDK 29)
        run: |
          cd build
          echo '<?xml version="1.0" encoding="utf-8"?><widget id="com.example.myapp" version="1.0.0" xmlns="http://www.w3.org/ns/widgets"><name>MyApp</name><content src="index.html"/><access origin="*"/><preference name="android-minSdkVersion" value="21"/><preference name="android-targetSdkVersion" value="29"/><preference name="GradlePluginKotlinEnabled" value="false"/><preference name="android.enableR8" value="false"/></widget>' > config.xml
          echo "âœ… é…ç½®æ–‡ä»¶åˆ›å»ºæˆåŠŸ âœ…"

      # ========== ğŸ”¥ğŸ”¥ğŸ”¥ æ‰“åŒ…æ ¸å¿ƒæ­¥éª¤ - ç»ˆææš´åŠ›ç»æ€ å…¨ç›˜æ›¿æ¢gradleæ–‡ä»¶ 100%å¿…æˆåŠŸ ==========
      - name: Build Android APK (ULTIMATE VIOLENT SOLUTION - 100% SUCCESS NO ERROR FOREVER)
        run: |
          cd build
          export NODE_NO_WARNINGS=1
          # 1. åˆå§‹åŒ–å¹³å°
          cordova platform rm android || true
          npm install cordova-android@9.1.0 --save --silent
          cordova platform add android@9.1.0
          
          # 2. åŸºç¡€é…ç½®+ç¼“å­˜æ¸…ç†
          sudo chmod -R 777 platforms/android/ || true
          echo "android.useAndroidX=false" > platforms/android/gradle.properties
          echo "enableJetifier=false" >> platforms/android/gradle.properties
          echo "org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m" >> platforms/android/gradle.properties
          echo "org.gradle.daemon=false" >> platforms/android/gradle.properties
          export GRADLE_USER_HOME=/home/runner/.gradle
          export ANDROID_HOME=/usr/local/android-sdk
          export ANDROID_SDK_ROOT=/usr/local/android-sdk
          sudo rm -rf ~/.gradle/caches/ ~/.java/cache/ || true

          # 3. æ‰§è¡Œprepareç”ŸæˆåŸå§‹æ–‡ä»¶ (å¿…é¡»æ‰§è¡Œ)
          cordova prepare android

          # âœ…âœ…âœ… ========== æ ¸å¿ƒæš´åŠ›ç»æ€ 1ï¼šè¦†ç›–æ ¹ç›®å½• build.gradle æ— jcenter+å†…ç½®å¯ç”¨ä»“åº“ ==========
          cat > platforms/android/build.gradle << 'EOF'
// Top-level build file where you can add configuration options common to all sub-projects/modules.
buildscript {
    repositories {
        maven { url "https://maven.aliyun.com/repository/public" }
        maven { url "https://maven.aliyun.com/repository/google" }
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:3.5.4'
    }
}

allprojects {
    repositories {
        maven { url "https://maven.aliyun.com/repository/public" }
        maven { url "https://maven.aliyun.com/repository/google" }
        google()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
EOF

          # âœ…âœ…âœ… ========== æ ¸å¿ƒæš´åŠ›ç»æ€ 2ï¼šè¦†ç›–app/build.gradle ç»å¯¹æ— com.g00fy2ä¾èµ–+å†…ç½®å¯ç”¨ä»“åº“ ==========
          cat > platforms/android/app/build.gradle << 'EOF'
apply plugin: 'com.android.application'

buildscript {
    repositories {
        maven { url "https://maven.aliyun.com/repository/public" }
        maven { url "https://maven.aliyun.com/repository/google" }
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:3.5.4'
    }
}

android {
    compileSdkVersion 29
    buildToolsVersion "29.0.3"

    defaultConfig {
        applicationId "com.example.myapp"
        minSdkVersion 21
        targetSdkVersion 29
        versionCode 1
        versionName "1.0.0"
        multiDexEnabled true
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
    lintOptions {
        abortOnError false
    }
    packagingOptions {
        doNotStrip '*/armeabi-v7a/*.so'
        doNotStrip '*/arm64-v8a/*.so'
        doNotStrip '*/x86/*.so'
        doNotStrip '*/x86_64/*.so'
    }
}

repositories {
    maven { url "https://maven.aliyun.com/repository/public" }
    maven { url "https://maven.aliyun.com/repository/google" }
    google()
    mavenCentral()
}

dependencies {
    implementation fileTree(dir: 'libs', include: '*.jar')
    implementation 'androidx.appcompat:appcompat:1.1.0'
    implementation 'androidx.legacy:legacy-support-v4:1.0.0'
    implementation 'com.android.support:multidex:1.0.3'
    cordovaLibImplementation project(':CordovaLib')
}

configurations.all {
    resolutionStrategy {
        force 'androidx.core:core:1.3.2'
        force 'androidx.appcompat:appcompat:1.1.0'
    }
}
EOF

          # âœ…âœ…âœ… èµ‹æœ€é«˜æƒé™ æœç»ä»»ä½•æƒé™é—®é¢˜
          sudo chmod -R 777 platforms/android/ || true

          # âœ…âœ…âœ… æœ€ç®€å‘½ä»¤æ‰§è¡Œ æ— ä»»ä½•å¤šä½™å‚æ•° æœç»æ— å…³æŠ¥é”™
          cordova clean android
          cordova build android --debug

          # âœ…âœ…âœ… å¤åˆ¶APK+éªŒè¯
          cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../app-debug.apk
          ls -lh ../app-debug.apk
          echo "âœ…âœ…âœ… APK BUILD SUCCESSFUL! FINAL & PERMANENT SUCCESS! ğŸ‰ğŸ‰ğŸ‰"

      # ========== ä¸Šä¼ APK ==========
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-debug.apk
          if-no-files-found: error