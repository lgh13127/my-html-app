name: Build Android APK
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-8-jdk-amd64
      ANDROID_HOME: /usr/local/android-sdk
      ANDROID_SDK_ROOT: /usr/local/android-sdk
      PATH: /usr/local/bin:/usr/bin:/usr/local/nodejs/bin:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/29.0.3:$JAVA_HOME/bin

    steps:
      - uses: actions/checkout@v4

      # 1. 安装Node.js 14（Cordova 9.x兼容版本）
      - name: Install Node.js 14
        uses: actions/setup-node@v4
        with:
          node-version: 14.x
          cache: 'npm'

      # 2. 安装Cordova 9.0.0（官方稳定版）
      - name: Install Cordova
        run: |
          npm install -g cordova@9.0.0
          cordova -v

      # 3. 安装Android SDK 29（完整依赖）
      - name: Install Android SDK 29
        run: |
          sudo mkdir -p $ANDROID_HOME && sudo chmod -R 777 $ANDROID_HOME
          curl -fsSL -o $ANDROID_HOME/sdk-tools.zip https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip
          unzip -o $ANDROID_HOME/sdk-tools.zip -d $ANDROID_HOME > /dev/null 2>&1
          yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses > /dev/null 2>&1
          $ANDROID_HOME/tools/bin/sdkmanager "platforms;android-29" "build-tools;29.0.3" "platform-tools" "extras;android;m2repository" "extras;google;m2repository" > /dev/null 2>&1

      # 4. 配置Java 8（Cordova 9.x必需）
      - name: Setup Java 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      # 5. 创建Cordova项目
      - name: Create Cordova Project
        run: |
          # 创建基础项目
          cordova create my-app com.example.myapp MyApp
          cd my-app
          
          # 添加www内容
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>My App</title><style>body{text-align:center;padding:60px;font-size:24px;}</style></head><body><h1>Hello Android!</h1><p>✅ APK BUILD SUCCESS ✅</p></body></html>" > www/index.html
          
          # 添加Android平台
          cordova platform add android@9.1.0 --save

      # 6. 创建Cordova Gradle Hook（核心：自动修复build.gradle）
      - name: Create Cordova Build Hook
        run: |
          cd my-app
          # 创建hooks目录
          mkdir -p hooks/before_build
          
          # 生成hook脚本：自动删除versioncompare依赖 + 禁用Jcenter
          cat > hooks/before_build/fix_gradle.js << 'EOF'
#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

// 定义build.gradle路径
const rootGradlePath = path.join(__dirname, '../../platforms/android/build.gradle');
const appGradlePath = path.join(__dirname, '../../platforms/android/app/build.gradle');
const cordovaLibGradlePath = path.join(__dirname, '../../platforms/android/CordovaLib/build.gradle');

// 修复函数：删除versioncompare依赖 + 替换仓库
function fixGradleFile(filePath) {
    if (!fs.existsSync(filePath)) {
        console.log(`⚠️ ${filePath} 不存在，跳过`);
        return;
    }
    
    let content = fs.readFileSync(filePath, 'utf8');
    
    // 1. 删除com.g00fy2:versioncompare:1.3.4依赖行
    content = content.replace(/classpath\s+["']com\.g00fy2:versioncompare:1\.3\.4["']/g, '');
    content = content.replace(/\n\s*\n/g, '\n'); // 清理空行
    
    // 2. 禁用Jcenter + 替换为阿里云仓库
    content = content.replace(/jcenter\(\)/g, 'jcenter { enabled = false }');
    content = content.replace(/repositories\s*\{\s*/g, `repositories {
        maven { url 'https://maven.aliyun.com/repository/public' }
        maven { url 'https://maven.aliyun.com/repository/google' }
    `);
    
    // 写入修复后的内容
    fs.writeFileSync(filePath, content, 'utf8');
    console.log(`✅ 修复完成：${filePath}`);
}

// 执行修复
fixGradleFile(rootGradlePath);
fixGradleFile(appGradlePath);
fixGradleFile(cordovaLibGradlePath);

// 修复gradle.properties
const gradlePropPath = path.join(__dirname, '../../platforms/android/gradle.properties');
if (fs.existsSync(gradlePropPath)) {
    let propContent = fs.readFileSync(gradlePropPath, 'utf8');
    propContent += `
android.useAndroidX=false
enableJetifier=false
org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m
org.gradle.daemon=false
`;
    fs.writeFileSync(gradlePropPath, propContent, 'utf8');
    console.log(`✅ 修复gradle.properties完成`);
}
EOF
          
          # 赋予hook脚本执行权限
          chmod +x hooks/before_build/fix_gradle.js

      # 7. 构建APK（极简流程，Cordova官方方式）
      - name: Build Android APK
        run: |
          cd my-app
          # 放开权限
          sudo chmod -R 777 platforms/android/
          sudo chown -R runner:runner platforms/android/
          
          # 执行构建（带详细日志）
          cordova build android --debug --verbose

      # 8. 复制APK并上传
      - name: Copy & Upload APK
        run: |
          # 检查APK是否存在
          APK_PATH="my-app/platforms/android/app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK_PATH" ]; then
              cp "$APK_PATH" app-debug.apk
              ls -lh app-debug.apk
              echo "✅✅✅ APK生成成功！路径：$(pwd)/app-debug.apk"
          else
              echo "❌ APK未找到，打印详细日志："
              ls -lh my-app/platforms/android/app/build/outputs/apk/ || true
              exit 1
          fi
        continue-on-error: false

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-debug.apk
          if-no-files-found: error