name: Build Android APK
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # å…¨å±€ç¯å¢ƒå˜é‡ï¼šè¡¥å…¨PATH+æ ¸å¿ƒç›®å½•ï¼Œç¡®ä¿æ‰€æœ‰å·¥å…·éƒ½èƒ½è¢«æ‰¾åˆ°
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-8-jdk-amd64
      ANDROID_HOME: /usr/local/lib/android/sdk
      PATH: /usr/bin:/usr/local/bin:/opt/gradle-6.7.1/bin:/usr/local/lib/android/sdk/platform-tools:/usr/local/lib/android/sdk/tools:$PATH

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç  - å”¯ä¸€å‰ç½®æ­¥éª¤
      - uses: actions/checkout@v4

      # ========== ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ã€ä¼˜å…ˆçº§TOP1 å¿…åœ¨æœ€å‰ã€‘ï¼šå®‰è£…æ‰€æœ‰ç¼ºå¤±ç³»ç»Ÿå·¥å…· ==========
      # è§£å†³tar/unzip/wget/zip/gzipç¼ºå¤± + æ›´æ–°ç³»ç»Ÿæºï¼Œæ‰§è¡Œæ—¶æœºï¼šæ£€å‡ºä»£ç åç«‹åˆ»æ‰§è¡Œï¼Œæ‰€æœ‰æ­¥éª¤ä¹‹å‰ï¼
      - name: Install All Required System Tools (tar/unzip/wget/zip/gzip) - FIX TAR ERROR
        run: |
          sudo apt-get update -y && sudo apt-get upgrade -y
          sudo apt-get install -y tar unzip wget zip gzip coreutils --no-install-recommends -qq
          # éªŒè¯tarå®‰è£…æˆåŠŸï¼Œæ‰“å°ç‰ˆæœ¬ï¼Œç¡®ä¿ä¿®å¤ç”Ÿæ•ˆ
          tar --version && echo "âœ… tarå®‰è£…æˆåŠŸ âœ…"
          unzip --version && echo "âœ… unzipå®‰è£…æˆåŠŸ âœ…"

      # æ­¥éª¤2ï¼šé…ç½®Android SDK 29 (å®Œç¾å…¼å®¹cordova-android9.1.0)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 29
          build-tools: 29.0.3
          run-sdkmanager: true

      # æ­¥éª¤3ï¼šé”å®šJava 8 (cordova9.xå”¯ä¸€å…¼å®¹ç‰ˆæœ¬ï¼Œä¸å¯ä¿®æ”¹)
      - name: Setup Java 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          java-package: jdk

      # æ­¥éª¤4ï¼šNode14 é»„é‡‘å…¼å®¹ç‰ˆæœ¬ (Cordova9æœ€ä½³æ­æ¡£)
      - name: Setup Node.js 14
        uses: actions/setup-node@v4
        with:
          node-version: '14'
          registry-url: https://registry.npmmirror.com/

      # æ­¥éª¤5ï¼šå…¨å±€å®‰è£…Cordova 9.0.0
      - name: Install Cordova 9.0.0
        run: npm install -g cordova@9.0.0 && cordova -v

      # æ­¥éª¤6ï¼šå®‰è£…Gradle6.7.1 å…¼å®¹ç‰ˆæœ¬ (å¸è½½é«˜ç‰ˆæœ¬+å®‰è£…å…¼å®¹ç‰ˆ)
      - name: Install Gradle 6.7.1 (Only Compatible Version)
        run: |
          sudo apt-get remove -y gradle > /dev/null 2>&1
          wget -q https://services.gradle.org/distributions/gradle-6.7.1-bin.zip -P /tmp
          unzip -q /tmp/gradle-6.7.1-bin.zip -d /opt
          sudo ln -sf /opt/gradle-6.7.1/bin/gradle /usr/local/bin/gradle
          gradle -v && echo "âœ… Gradle6.7.1å®‰è£…æˆåŠŸ âœ…"

      # æ­¥éª¤7ï¼šå®‰å…¨åˆ›å»ºç½‘é¡µæ–‡ä»¶ é›¶YAMLè¯­æ³•é£é™©
      - name: Create WWW Files
        run: |
          mkdir -p www
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/icon.png
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/splash.png
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>My App</title><style>body{text-align:center;padding:60px;font-size:22px;}</style></head><body><h1>Hello Android!</h1><p>âœ… Build Success âœ…</p></body></html>' > www/index.html

      # æ­¥éª¤8ï¼šåˆ›å»ºCordovaé¡¹ç›®
      - name: Create Cordova Project
        run: cordova create build com.example.myapp MyApp && cd build && cp -r ../www ./

      # æ­¥éª¤9ï¼šå¸¦å®Œæ•´ç¼–è¯‘ä¿®å¤çš„config.xml (AndroidX+ç¦ç”¨R8+æ ¸å¿ƒå…¼å®¹)
      - name: Create Config.xml (Full Compatibility)
        run: |
          cd build
          echo '<?xml version="1.0" encoding="utf-8"?><widget id="com.example.myapp" version="1.0.0" xmlns="http://www.w3.org/ns/widgets"><name>MyApp</name><content src="index.html"/><access origin="*"/><preference name="android-minSdkVersion" value="21"/><preference name="android-targetSdkVersion" value="29"/><preference name="AndroidXEnabled" value="true"/><preference name="GradlePluginKotlinEnabled" value="false"/><preference name="android.enableR8" value="false"/><preference name="loadUrlTimeoutValue" value="700000"/></widget>' > config.xml

      # æ­¥éª¤10ï¼šç»ˆææ‰“åŒ…æ­¥éª¤ã€æ‰€æœ‰ä¿®å¤æ•´åˆï¼Œå¿…æˆåŠŸã€‘
      - name: Build Android APK (100% Success All Fix)
        run: |
          cd build
          npm install cordova-android@9.1.0 --save
          cordova platform add android@9.1.0 --nofetch
          # ç»™gradleè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x platforms/android/gradlew
          # å¼ºåˆ¶æŒ‡å®šgradle6.7.1ï¼Œé¿å…ç³»ç»Ÿè°ƒç”¨é«˜ç‰ˆæœ¬
          export CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL=https\://services.gradle.org/distributions/gradle-6.7.1-all.zip
          export GRADLE_OPTS="-Xmx2048m -Dorg.gradle.jvmargs='-Xmx2048m'"
          # æ¸…ç†ç¼“å­˜ï¼Œé¿å…ç¼–è¯‘å†²çª
          ./platforms/android/gradlew clean -p platforms/android
          # ç¼–è¯‘Debugç‰ˆAPK
          cordova build android --debug -- --gradleArg=-Dorg.gradle.daemon=false --gradleArg=-Dorg.gradle.parallel=false
          # å¤åˆ¶APKåˆ°æ ¹ç›®å½•
          cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../app-debug.apk
          # éªŒè¯APKç”Ÿæˆ
          ls -lh ../app-debug.apk
          echo "âœ… æ­å–œï¼APKæ‰“åŒ…æˆåŠŸï¼âœ…"

      # æ­¥éª¤11ï¼šä¸Šä¼ APKäº§ç‰©
      - name: Upload APK File
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-debug.apk
          if-no-files-found: error