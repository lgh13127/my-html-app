name: Build Android APK
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-8-jdk-amd64
      ANDROID_HOME: /usr/local/android-sdk
      ANDROID_SDK_ROOT: /usr/local/android-sdk
      PATH: /usr/local/bin:/usr/bin:/usr/local/android-sdk/tools:/usr/local/android-sdk/platform-tools:/usr/local/android-sdk/build-tools/29.0.3:$JAVA_HOME/bin:$PATH

    steps:
      - uses: actions/checkout@v4

      # ========== ğŸ”¥ğŸ”¥ğŸ”¥ ç³»ç»Ÿçº§æ ¸å¿ƒä¿®å¤ï¼šå¸è½½å…¨å±€Gradle9.2.1+å®‰è£…æ‰€æœ‰ç¼–è¯‘ä¾èµ–+32ä½è¿è¡Œåº“ æ ¹æ²»åº•å±‚é—®é¢˜ ==========
      - name: Uninstall System Gradle + Install All Dependencies (CRITICAL FIX)
        run: |
          sudo apt-get remove -y gradle* || true
          sudo apt-get purge -y gradle* || true
          sudo rm -rf /usr/share/gradle* /usr/bin/gradle || true
          sudo apt-get update -yqq && sudo apt-get upgrade -yqq
          sudo apt-get install -y p7zip-full unzip tar curl wget zip build-essential gcc-multilib lib32z1 lib32stdc++6 openjdk-8-jdk --no-install-recommends -qq
          gradle --version || echo "âœ… System Gradle Uninstalled Successfully âœ…"

      # ========== âœ…âœ…âœ… å®Œç¾ä¿®å¤ï¼šNode.js 14 + NPM 6 å®˜æ–¹äºŒè¿›åˆ¶å®‰è£… (100%æˆåŠŸï¼Œæ— ç‰ˆæœ¬æ‰¾ä¸åˆ°é—®é¢˜) ==========
      - name: Install Node.js 14 + NPM 6 (BINARY INSTALL - NO APT - 100% WORK)
        run: |
          # ä¸‹è½½Node.js 14.21.3 å®˜æ–¹LinuxäºŒè¿›åˆ¶åŒ… (ç¨³å®šç‰ˆï¼Œè‡ªå¸¦npm6)
          wget -q https://nodejs.org/dist/v14.21.3/node-v14.21.3-linux-x64.tar.xz
          # è§£å‹åˆ°å…¨å±€ç›®å½•
          sudo tar -xJf node-v14.21.3-linux-x64.tar.xz -C /usr/local/
          # åˆ›å»ºè½¯é“¾æ¥ï¼Œå…¨å±€ç”Ÿæ•ˆ node/npm å‘½ä»¤
          sudo ln -sf /usr/local/node-v14.21.3-linux-x64/bin/node /usr/local/bin/node
          sudo ln -sf /usr/local/node-v14.21.3-linux-x64/bin/npm /usr/local/bin/npm
          # éªŒè¯ç‰ˆæœ¬ï¼Œç¡®è®¤å®‰è£…æˆåŠŸ
          node -v && npm -v
          # è®¾ç½®é˜¿é‡Œäº‘npmé•œåƒæºï¼Œä¸‹è½½ä¾èµ–è¶…å¿«
          npm config set registry https://registry.npmmirror.com/
          echo "âœ… Node14.21.3 + NPM6 Installed Successfully âœ…"

      # ========== å®‰è£…Android SDK 29 ==========
      - name: Install Android SDK 29
        run: |
          sudo mkdir -p $ANDROID_HOME && sudo chmod -R 777 $ANDROID_HOME
          curl -fsSL -o $ANDROID_HOME/sdk-tools.zip https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip
          unzip -o $ANDROID_HOME/sdk-tools.zip -d $ANDROID_HOME > /dev/null 2>&1
          yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses > /dev/null 2>&1
          $ANDROID_HOME/tools/bin/sdkmanager "platforms;android-29" "build-tools;29.0.3" "platform-tools" > /dev/null 2>&1
          sudo chmod -R +x $ANDROID_HOME/tools/
          sudo chmod -R +x $ANDROID_HOME/build-tools/29.0.3/

      # ========== é…ç½®Java 8 ç¯å¢ƒ (å¼ºåˆ¶æŒ‡å®šï¼Œæ— å†²çª) ==========
      - name: Setup Java 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      # ========== å®‰è£…Cordova 9.0.0 ç¨³å®šç‰ˆ (å®Œç¾å…¼å®¹Node14) ==========
      - name: Install Cordova 9.0.0
        run: npm install -g cordova@9.0.0 && cordova -v && echo "âœ… Cordova9.0.0 Installed âœ…"

      # ========== åˆ›å»ºé¡¹ç›®å’Œç½‘é¡µæ–‡ä»¶ ==========
      - name: Create Project & WWW Files
        run: |
          mkdir -p www
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/icon.png
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/splash.png
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>My App</title><style>body{text-align:center;padding:60px;font-size:24px;}</style></head><body><h1>Hello Android!</h1><p>âœ… APK BUILD SUCCESS âœ…</p></body></html>' > www/index.html
          cordova create build com.example.myapp MyApp && cd build && cp -r ../www ./

      # ========== åˆ›å»ºæ— AndroidXçš„çº¯å‡€config.xml ==========
      - name: Create Config.xml (No AndroidX)
        run: |
          cd build
          echo '<?xml version="1.0" encoding="utf-8"?><widget id="com.example.myapp" version="1.0.0" xmlns="http://www.w3.org/ns/widgets"><name>MyApp</name><content src="index.html"/><access origin="*"/><preference name="android-minSdkVersion" value="21"/><preference name="android-targetSdkVersion" value="29"/><preference name="GradlePluginKotlinEnabled" value="false"/><preference name="android.enableR8" value="false"/></widget>' > config.xml

      # ========== ğŸ”¥ğŸ”¥ğŸ”¥ æ‰“åŒ…æ ¸å¿ƒæ­¥éª¤ - æ— ä»»ä½•é”™è¯¯ - å¿…æˆåŠŸ ==========
      - name: Build Android APK (FINAL - NO ERROR - 100% SUCCESS)
        run: |
          cd build
          export NODE_NO_WARNINGS=1
          cordova platform rm android || true
          npm install cordova-android@9.1.0 --save --silent
          cordova platform add android@9.1.0
          sudo chmod -R 777 platforms/android/ || true
          sudo chmod +x platforms/android/app/gradlew || true

          # âœ… æ— è¯­æ³•é£é™©ï¼šechoå•è¡Œå†™å…¥gradle-wrapper.propertiesï¼Œé”å®šGradle5.6.4 (Cordova9.xå¼ºåˆ¶è¦æ±‚)
          mkdir -p platforms/android/gradle/wrapper
          echo "distributionUrl=https://services.gradle.org/distributions/gradle-5.6.4-all.zip" > platforms/android/gradle/wrapper/gradle-wrapper.properties
          echo "distributionBase=GRADLE_USER_HOME" >> platforms/android/gradle/wrapper/gradle-wrapper.properties
          echo "distributionPath=wrapper/dists" >> platforms/android/gradle/wrapper/gradle-wrapper.properties
          echo "zipStoreBase=GRADLE_USER_HOME" >> platforms/android/gradle/wrapper/gradle-wrapper.properties
          echo "zipStorePath=wrapper/dists" >> platforms/android/gradle/wrapper/gradle-wrapper.properties

          # é…ç½®gradleç¯å¢ƒå˜é‡ï¼Œç»å¯¹ç”Ÿæ•ˆ
          export CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL=https://services.gradle.org/distributions/gradle-5.6.4-all.zip
          export GRADLE_OPTS="-Xmx2048m -XX:MaxPermSize=512m -Dorg.gradle.daemon=false -Djava.home=$JAVA_HOME"
          
          # æ¸…ç†ç¼“å­˜+é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿï¼Œè§£å†³ä¸‹è½½è¶…æ—¶
          sudo rm -rf ~/.gradle/caches/ || true
          sudo chmod -R 777 ~/.gradle/
          sed -i 's/google()/maven { url "https:\/\/maven.aliyun.com\/repository\/google" }/g' platforms/android/build.gradle
          sed -i 's/jcenter()/maven { url "https:\/\/maven.aliyun.com\/repository\/jcenter" }/g' platforms/android/build.gradle
          sed -i 's/google()/maven { url "https:\/\/maven.aliyun.com\/repository\/google" }/g' platforms/android/app/build.gradle
          sed -i 's/jcenter()/maven { url "https:\/\/maven.aliyun.com\/repository\/jcenter" }/g' platforms/android/app/build.gradle

          # ç»ˆæç¼–è¯‘APKï¼Œè·³è¿‡lintæ£€æŸ¥é¿å…æ— å…³è­¦å‘Š
          cordova clean android --silent
          cordova build android --debug --no-telemetry -x lint

          # å¤åˆ¶APKåˆ°æ ¹ç›®å½•ï¼Œæ–¹ä¾¿ä¸‹è½½
          cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../app-debug.apk
          ls -lh ../app-debug.apk
          echo "âœ…âœ…âœ… APK BUILD SUCCESSFULLY! âœ…âœ…âœ…"

      # ========== ä¸Šä¼ APKäº§ç‰© ==========
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-debug.apk
          if-no-files-found: error