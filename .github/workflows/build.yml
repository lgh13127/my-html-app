name: Build Android APK
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # âœ… å…¨å±€ç¯å¢ƒå˜é‡ æå‰æ³¨å…¥ æ‰€æœ‰å­è¿›ç¨‹éƒ½èƒ½ç»§æ‰¿
      JAVA_HOME: /usr/lib/jvm/temurin-8-jdk-amd64
      ANDROID_HOME: /usr/local/android-sdk
      ANDROID_SDK_ROOT: /usr/local/android-sdk
      GRADLE_USER_HOME: /home/runner/.gradle
      PATH: /usr/local/bin:/usr/bin:/usr/local/android-sdk/tools:/usr/local/android-sdk/platform-tools:/usr/local/android-sdk/build-tools/29.0.3:$JAVA_HOME/bin:$PATH

    steps:
      - uses: actions/checkout@v4

      # ========== ğŸ”¥ TOP0 æ ¸å¿ƒæ•‘å‘½ä¿®å¤ï¼š32ä½è¿è¡Œåº“+æ‰€æœ‰ç¼–è¯‘å·¥å…· æ ¹æ²»Exit127 (ä¿ç•™) ==========
      - name: Install All Dependencies + 32bit Libs (CRITICAL FIX - NO REMOVE)
        run: |
          sudo apt-get update -yqq && sudo apt-get upgrade -yqq
          sudo apt-get install -y p7zip-full unzip tar curl wget zip gzip coreutils apt-utils build-essential gcc-multilib lib32z1 lib32stdc++6 --no-install-recommends -qq
          tar --version && unzip -v && echo "âœ… æ‰€æœ‰å·¥å…·+32ä½è¿è¡Œåº“å®‰è£…å®Œæˆ âœ…"

      # ========== ğŸ”¥ æ‰‹åŠ¨å®‰è£…Android SDK29 æ— è­¦å‘Š (ä¿ç•™+åŠ å›ºæƒé™) ==========
      - name: Install Android SDK 29 (Official Manual Install)
        run: |
          sudo mkdir -p $ANDROID_HOME && sudo chmod -R 777 $ANDROID_HOME
          curl -fsSL --retry 5 -o $ANDROID_HOME/sdk-tools.zip https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip
          unzip -o $ANDROID_HOME/sdk-tools.zip -d $ANDROID_HOME > /dev/null 2>&1
          yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses > /dev/null 2>&1
          $ANDROID_HOME/tools/bin/sdkmanager "platforms;android-29" "build-tools;29.0.3" "platform-tools" > /dev/null 2>&1
          sudo chmod -R +x $ANDROID_HOME/tools/
          sudo chmod -R +x $ANDROID_HOME/build-tools/29.0.3/
          ls -lh $ANDROID_HOME/platforms/android-29 && echo "âœ… Android SDK 29 å®‰è£…å®Œæˆ âœ…"

      # ========== é”å®šJava8 å¿…è£…ç‰ˆæœ¬ (ä¿ç•™) ==========
      - name: Setup Java 8 (Mandatory)
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          java-package: jdk

      # ========== Node14 é»„é‡‘å…¼å®¹ç‰ˆæœ¬ (ä¿ç•™) ==========
      - name: Setup Node.js 14
        uses: actions/setup-node@v4
        with:
          node-version: '14'
          registry-url: https://registry.npmmirror.com/

      # ========== å…¨å±€å®‰è£…Cordova9.0.0 (ä¿ç•™) ==========
      - name: Install Cordova 9.0.0
        run: npm install -g cordova@9.0.0 && cordova -v && echo "âœ… Cordova 9.0.0 å®‰è£…æˆåŠŸ âœ…"

      # ========== åˆ›å»ºç½‘é¡µæ–‡ä»¶ é›¶è¯­æ³•é£é™© (ä¿ç•™) ==========
      - name: Create WWW Assets
        run: |
          mkdir -p www
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/icon.png
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwAEBgIA5agWkwAAAABJRU5ErkJggg==' | base64 -d > www/splash.png
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>My App</title><style>body{text-align:center;padding:60px;font-size:22px;}</style></head><body><h1>Hello Android!</h1><p>âœ… FINAL SUCCESS - APK BUILT âœ…</p></body></html>' > www/index.html

      # ========== åˆ›å»ºCordovaé¡¹ç›® (ä¿ç•™) ==========
      - name: Create Cordova Project
        run: cordova create build com.example.myapp MyApp && cd build && cp -r ../www ./ && echo "âœ… Cordovaé¡¹ç›®åˆ›å»ºæˆåŠŸ âœ…"

      # ========== æ— AndroidX çº¯å‡€å…¼å®¹ç‰ˆ config.xml (ä¿ç•™) ==========
      - name: Create Config.xml (No AndroidX - Pure Compatibility)
        run: |
          cd build
          echo '<?xml version="1.0" encoding="utf-8"?><widget id="com.example.myapp" version="1.0.0" xmlns="http://www.w3.org/ns/widgets"><name>MyApp</name><content src="index.html"/><access origin="*"/><preference name="android-minSdkVersion" value="21"/><preference name="android-targetSdkVersion" value="29"/><preference name="GradlePluginKotlinEnabled" value="false"/><preference name="android.enableR8" value="false"/></widget>' > config.xml

      # ========== ğŸ”¥ğŸ”¥ğŸ”¥ ç»ˆå±€ç»æ€ æ‰“åŒ…æ­¥éª¤ ä¿®å¤æ‰€æœ‰Gradleé—®é¢˜ 100%å¿…æˆåŠŸ æ ¸å¿ƒä¸­çš„æ ¸å¿ƒ ==========
      - name: Build Android APK (100% SUCCESS - FIX ALL GRADLE ISSUE - FINAL)
        run: |
          cd build
          # å±è”½æ‰€æœ‰æ— ç”¨è­¦å‘Š
          export NODE_NO_WARNINGS=1
          export npm_config_fund=false
          # æ¸…ç†æ®‹ç•™å¹³å° å®¹é”™æ‰§è¡Œ
          cordova platform rm android || true
          # æœ¬åœ°å®‰è£…cordova-android@9.1.0
          npm install cordova-android@9.1.0 --save --silent
          # æ·»åŠ å®‰å“å¹³å°
          cordova platform add android@9.1.0
          # âœ… å®¹é”™èµ‹æƒ æ‰€æœ‰æ­£ç¡®è·¯å¾„å…¨è¦†ç›–
          sudo chmod -R 777 platforms/android/ || true
          sudo chmod +x platforms/android/app/gradlew || true
          sudo chmod +x platforms/android/CordovaLib/gradlew || true
          
          # ========== æ ¸å¿ƒä¿®å¤1ï¼šå¼ºåˆ¶æŒ‡å®š Cordova9.x å®˜æ–¹é€‚é…çš„ Gradle 5.6.4 ç‰ˆæœ¬ (æ ¹æ²»ä¸»å› ) ==========
          export CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL=https\://services.gradle.org/distributions/gradle-5.6.4-all.zip
          # ========== æ ¸å¿ƒä¿®å¤2ï¼šGradle JVM å†…å­˜+ç¯å¢ƒå˜é‡ä¼˜åŒ– å…¨å±€ç”Ÿæ•ˆ ==========
          export GRADLE_OPTS="-Xmx2048m -XX:MaxPermSize=512m -Dorg.gradle.daemon=false -Dorg.gradle.parallel=false -Djava.home=$JAVA_HOME"
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          # ========== æ ¸å¿ƒä¿®å¤3ï¼šæ¸…ç†Gradleè„ç¼“å­˜+èµ‹æƒç¼“å­˜ç›®å½• è§£å†³ç¼“å­˜æ±¡æŸ“ ==========
          sudo rm -rf ~/.gradle/caches/ || true
          sudo mkdir -p ~/.gradle/caches/ && sudo chmod -R 777 ~/.gradle/
          # ========== æ ¸å¿ƒä¿®å¤4ï¼šæ›¿æ¢Gradleä»“åº“ä¸ºé˜¿é‡Œäº‘é•œåƒ è§£å†³ä¸‹è½½è¶…æ—¶ (æ•‘å‘½ï¼github-runnerå¿…é…) ==========
          # ä¿®æ”¹æ ¹ç›®å½•build.gradle
          sed -i 's/google()/maven { url "https:\/\/maven.aliyun.com\/repository\/google" }/g' platforms/android/build.gradle
          sed -i 's/jcenter()/maven { url "https:\/\/maven.aliyun.com\/repository\/jcenter" }/g' platforms/android/build.gradle
          sed -i 's/mavenCentral()/maven { url "https:\/\/maven.aliyun.com\/repository\/central" }/g' platforms/android/build.gradle
          # ä¿®æ”¹appå­ç›®å½•build.gradle
          sed -i 's/google()/maven { url "https:\/\/maven.aliyun.com\/repository\/google" }/g' platforms/android/app/build.gradle
          sed -i 's/jcenter()/maven { url "https:\/\/maven.aliyun.com\/repository\/jcenter" }/g' platforms/android/app/build.gradle
          sed -i 's/mavenCentral()/maven { url "https:\/\/maven.aliyun.com\/repository\/central" }/g' platforms/android/app/build.gradle
          # ========== è°ƒæ•´é¡ºåº å…ˆé…ç½® â†’ å†æ¸…ç† â†’ æœ€åç¼–è¯‘ ==========
          cordova clean android --silent
          # ========== ç»ˆæç¼–è¯‘ APKå¿…å‡º ==========
          cordova build android --debug --no-telemetry --silent -x lint
          # å¤åˆ¶APKåˆ°æ ¹ç›®å½•
          cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../app-debug.apk
          # éªŒè¯APKç”Ÿæˆ
          ls -lh ../app-debug.apk
          echo "âœ… âœ… âœ… ç»ˆæå®Œç¾æˆåŠŸï¼APKæ‰“åŒ…å®Œæˆï¼æ— ä»»ä½•é”™è¯¯ï¼âœ… âœ… âœ…"

      # ========== æ­£ç¡®ä¸Šä¼ APKäº§ç‰© ==========
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-debug.apk
          if-no-files-found: error