<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¼”æ’­æ™ºè”-é€šè¯</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        .control-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-field {
            width: 100%;
        }
        
        .input-field label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }
        
        .input-field input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }
        
        .input-field input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-field input::placeholder {
            color: #aaa;
            font-size: 14px;
        }
        
        .token-hint {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .token-hint i {
            color: #ff9800;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        button {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            min-height: 56px;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .call-btn {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
        }
        
        .call-btn:hover {
            background: linear-gradient(to right, #5a6fd8, #6b4190);
        }
        
        .call-btn.in-call {
            background: linear-gradient(to right, #ff6b6b, #ff5252);
        }
        
        .call-btn.in-call:hover {
            background: linear-gradient(to right, #ff5252, #e53935);
        }
        
        .mic-btn {
            background: #4CAF50;
            color: white;
        }
        
        .mic-btn:hover {
            background: #43a047;
        }
        
        .mic-btn.muted {
            background: #ff6b6b;
        }
        
        .mic-btn.muted:hover {
            background: #ff5252;
        }
        
        .members-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .members-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .members-header h2 {
            color: #333;
            font-size: 18px;
        }
        
        .members-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .members-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .member-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            border-color: #667eea;
        }
        
        .member-card.local {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }
        
        .avatar.local {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .avatar.remote {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        
        .member-info {
            flex: 1;
            min-width: 0;
        }
        
        .member-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .member-uid {
            color: #666;
            font-size: 12px;
            margin-bottom: 6px;
        }
        
        .member-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-online {
            background: #e8f5e9;
            color: #2E7D32;
        }
        
        .status-muted {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-speaker {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .member-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .mute-btn {
            background: #ffebee;
            color: #c62828;
        }
        
        .mute-btn:hover {
            background: #ffcdd2;
        }
        
        .mute-btn.muted {
            background: #e0e0e0;
            color: #616161;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
            color: #ccc;
        }
        
        .empty-state p {
            font-size: 14px;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 12px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .call-status {
            text-align: center;
            margin: 15px 0;
            padding: 12px;
            border-radius: 10px;
            background: #f8f9fa;
            font-weight: 600;
            font-size: 14px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .call-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .call-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .mobile-hint {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 12px 15px;
            margin: 15px 0;
            font-size: 12px;
            color: #1565c0;
            border-left: 4px solid #2196f3;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mobile-hint i {
            font-size: 16px;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (min-width: 768px) {
            .container {
                padding: 30px;
            }
            
            .input-group {
                flex-direction: row;
            }
            
            .input-field {
                flex: 1;
            }
            
            .button-group {
                flex-direction: row;
            }
            
            button {
                width: auto;
                min-width: 160px;
            }
            
            .members-list {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
            
            .mobile-hint {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .header p {
                font-size: 13px;
            }
            
            .control-panel {
                padding: 15px;
            }
            
            button {
                padding: 14px 20px;
                font-size: 15px;
                min-height: 50px;
            }
            
            .member-card {
                padding: 12px;
            }
            
            .avatar {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }
        }
        
        /* é˜²æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ æ¼”æ’­æ™ºè”-é€šè¯</h1>
            <p>éšæ—¶éšåœ°ï¼Œæ¸…æ™°é€šè¯</p>
        </div>
        
        <div class="control-panel">
            <div class="input-group">
                <div class="input-field">
                    <label for="channelName"><i class="fas fa-hashtag"></i> é¢‘é“åç§°</label>
                    <input type="text" id="channelName" placeholder="å¦‚ï¼šmeeting-room-1" autocomplete="off">
                </div>
                
                <div class="input-field">
                    <label for="tokenInput"><i class="fas fa-key"></i> é‰´æƒä»¤ç‰Œ</label>
                    <input type="text" id="tokenInput" placeholder="è¾“å…¥ä¸´æ—¶Token" autocomplete="off">
                    <div class="token-hint">
                        <i class="fas fa-info-circle"></i>
                        <span>ç®¡ç†å‘˜ä¸‹å‘çš„ä¸´æ—¶Token</span>
                    </div>
                </div>
            </div>
            
                        
            <div class="button-group">
                <button class="call-btn" id="callToggle">
                    <i class="fas fa-phone-alt"></i>
                    <span id="callText">åŠ å…¥é€šè¯</span>
                </button>
                <button class="mic-btn" id="micToggle" disabled>
                    <i class="fas fa-microphone"></i>
                    <span id="micText">å¼€å¯è¯ç­’</span>
                </button>
            </div>
            
            <div id="callStatus" class="call-status">
                <i class="fas fa-circle-notch fa-spin"></i>
                <span id="statusText">æ­£åœ¨è¿æ¥...</span>
            </div>
        </div>
        
        <div class="members-container">
            <div class="members-header">
                <h2><i class="fas fa-users"></i> é€šè¯æˆå‘˜</h2>
                <div class="members-count">
                    <span id="memberCount">0</span> äººåœ¨çº¿
                </div>
            </div>
            
            <div id="membersList" class="members-list">
                <div class="empty-state">
                    <i class="fas fa-user-friends"></i>
                    <p>é¢‘é“å†…æš‚æ— æˆå‘˜</p>
                    <p style="font-size: 11px; margin-top: 5px;">åŠ å…¥é¢‘é“åï¼Œæˆå‘˜åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>ä¸ªäººè‡ªç ” æ¬¢è¿è¯•ç”¨</p>
        </div>
    </div>

    <!-- å¼•å…¥å£°ç½‘ Web SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.21.0.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let rtcClient = null;
        let localAudioTrack = null;
        let isPublished = false;
        let isMicrophoneMuted = true;
        let isInCall = false;
        let members = new Map();
        const APP_ID = "4531524ecba946fd868fc547c6d269d7";
        
        // DOMå…ƒç´ å¼•ç”¨
        let callToggleBtn, micToggleBtn, callTextSpan, micTextSpan;
        let callStatusDiv, statusTextSpan;
        let channelNameInput, tokenInput, membersListDiv, memberCountSpan;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async function() {
            // è·å–DOMå…ƒç´ 
            callToggleBtn = document.getElementById('callToggle');
            micToggleBtn = document.getElementById('micToggle');
            callTextSpan = document.getElementById('callText');
            micTextSpan = document.getElementById('micText');
            callStatusDiv = document.getElementById('callStatus');
            statusTextSpan = document.getElementById('statusText');
            channelNameInput = document.getElementById('channelName');
            tokenInput = document.getElementById('tokenInput');
            membersListDiv = document.getElementById('membersList');
            memberCountSpan = document.getElementById('memberCount');
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            if (callToggleBtn) {
                callToggleBtn.addEventListener('click', toggleCall);
            }
            
            if (micToggleBtn) {
                micToggleBtn.addEventListener('click', toggleMicrophone);
            }
            
            // è®¾ç½®åˆå§‹çŠ¶æ€
            updateMembersDisplay();
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // ç›‘å¬é¡µé¢å…³é—­
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šé¢„è¯·æ±‚éº¦å…‹é£æƒé™
            await optimizeForMobile();
            
            console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
        
        // ç§»åŠ¨ç«¯ä¼˜åŒ–
        async function optimizeForMobile() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                console.log('æ£€æµ‹åˆ°ç§»åŠ¨ç«¯ï¼Œè¿›è¡Œä¼˜åŒ–');
                
                // ä¸ºç§»åŠ¨ç«¯è‡ªåŠ¨è¯·æ±‚éº¦å…‹é£æƒé™ï¼ˆæå‰å‡†å¤‡ï¼‰
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('ç§»åŠ¨ç«¯éº¦å…‹é£æƒé™é¢„è¯·æ±‚æˆåŠŸ');
                } catch (err) {
                    console.log('ç§»åŠ¨ç«¯éº¦å…‹é£æƒé™é¢„è¯·æ±‚å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', err.message);
                }
            }
        }
        
        // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
        function handleVisibilityChange() {
            if (document.hidden && isInCall) {
                console.log('é¡µé¢è¿›å…¥åå°ï¼Œé€šè¯ä¿æŒä¸­...');
            } else if (isInCall) {
                console.log('é¡µé¢å›åˆ°å‰å°');
            }
        }
        
        // å¤„ç†é¡µé¢å…³é—­
        function handleBeforeUnload(e) {
            if (isInCall) {
                const confirmationMessage = 'æ‚¨æ­£åœ¨é€šè¯ä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        }
        
        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        async function initRtcClient() {
            if (rtcClient) return;
            
            try {
                rtcClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                
                // ç›‘å¬è¿œç¨‹ç”¨æˆ·åŠ å…¥
                rtcClient.on("user-published", async (user, mediaType) => {
                    try {
                        await rtcClient.subscribe(user, mediaType);
                        if (mediaType === "audio") {
                            const remoteAudioTrack = user.audioTrack;
                            remoteAudioTrack.play();
                            
                            // æ·»åŠ è¿œç¨‹æˆå‘˜åˆ°åˆ—è¡¨
                            addMember(user.uid, false, remoteAudioTrack);
                            updateMembersDisplay();
                            console.log(`å·²è®¢é˜…è¿œç¨‹ç”¨æˆ· ${user.uid} çš„éŸ³é¢‘`);
                        }
                    } catch (subscribeErr) {
                        console.error("è®¢é˜…è¿œç¨‹ç”¨æˆ·å¤±è´¥ï¼š", subscribeErr);
                    }
                });
                
                // ç›‘å¬ç”¨æˆ·å–æ¶ˆå‘å¸ƒ
                rtcClient.on("user-unpublished", (user, mediaType) => {
                    const member = members.get(user.uid.toString());
                    if (member && !member.isLocal) {
                        member.isMuted = true;
                        updateMembersDisplay();
                        console.log(`ç”¨æˆ· ${user.uid} å·²å…³é—­éº¦å…‹é£`);
                    }
                });
                
                // ç›‘å¬ç”¨æˆ·ç¦»å¼€é¢‘é“
                rtcClient.on("user-left", (user) => {
                    removeMember(user.uid);
                    updateMembersDisplay();
                    console.log(`ç”¨æˆ· ${user.uid} å·²ç¦»å¼€é¢‘é“`);
                });
                
                // ç›‘å¬ç”¨æˆ·é‡æ–°å‘å¸ƒåª’ä½“æµ
                rtcClient.on("user-published", async (user, mediaType) => {
                    if (mediaType === "audio" && members.has(user.uid.toString())) {
                        try {
                            await rtcClient.subscribe(user, mediaType);
                            const remoteAudioTrack = user.audioTrack;
                            remoteAudioTrack.play();
                            
                            const member = members.get(user.uid.toString());
                            if (member) {
                                member.audioTrack = remoteAudioTrack;
                                member.isMuted = false;
                                updateMembersDisplay();
                                console.log(`ç”¨æˆ· ${user.uid} é‡æ–°å¼€å¯éº¦å…‹é£`);
                            }
                        } catch (subscribeErr) {
                            console.error("é‡æ–°è®¢é˜…ç”¨æˆ·å¤±è´¥ï¼š", subscribeErr);
                        }
                    }
                });
                
            } catch (initErr) {
                console.error("å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼š", initErr);
                throw initErr;
            }
        }
        
        // åˆ›å»ºéº¦å…‹é£éŸ³é¢‘è½¨é“
        async function createMicrophoneAudioTrack() {
            try {
                // ä½¿ç”¨æµè§ˆå™¨é»˜è®¤éº¦å…‹é£ï¼Œå¯ç”¨éŸ³é¢‘å¤„ç†
                return await AgoraRTC.createMicrophoneAudioTrack({
                    encoderConfig: 'music_standard',
                    AEC: true,  // å›å£°æ¶ˆé™¤
                    ANS: true,  // å™ªå£°æŠ‘åˆ¶
                    AGC: true   // è‡ªåŠ¨å¢ç›Šæ§åˆ¶
                });
            } catch (error) {
                console.error('åˆ›å»ºéº¦å…‹é£éŸ³é¢‘è½¨é“å¤±è´¥:', error);
                throw error;
            }
        }
        
        // æ·»åŠ æˆå‘˜
        function addMember(uid, isLocal = false, audioTrack = null) {
            if (members.has(uid.toString())) {
                const existingMember = members.get(uid.toString());
                existingMember.audioTrack = audioTrack;
                existingMember.isMuted = false;
            } else {
                const member = {
                    uid: uid,
                    isLocal: isLocal,
                    audioTrack: audioTrack,
                    isMuted: false,
                    isSpeaking: false
                };
                members.set(uid.toString(), member);
            }
        }
        
        // ç§»é™¤æˆå‘˜
        function removeMember(uid) {
            members.delete(uid.toString());
        }
        
        // æ›´æ–°æˆå‘˜æ˜¾ç¤º
        function updateMembersDisplay() {
            if (!membersListDiv || !memberCountSpan) {
                console.warn('æˆå‘˜åˆ—è¡¨å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            if (members.size === 0) {
                membersListDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <p>é¢‘é“å†…æš‚æ— æˆå‘˜</p>
                        <p style="font-size: 11px; margin-top: 5px;">åŠ å…¥é¢‘é“åï¼Œæˆå‘˜åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                    </div>
                `;
                memberCountSpan.textContent = "0";
                return;
            }
            
            memberCountSpan.textContent = members.size.toString();
            
            let membersHTML = "";
            
            members.forEach(member => {
                const isLocal = member.isLocal;
                const uid = member.uid;
                
                const colors = ['#667eea', '#764ba2', '#4CAF50', '#FF9800', '#E91E63', '#9C27B0'];
                const colorIndex = parseInt(uid) % colors.length || 0;
                
                let statusClass = "status-online";
                let statusText = "åœ¨çº¿";
                let statusIcon = "fa-circle";
                
                let isActuallyMuted = member.isMuted;
                if (isLocal) {
                    isActuallyMuted = isMicrophoneMuted;
                }
                
                if (isActuallyMuted) {
                    statusClass = "status-muted";
                    statusText = "å·²é™éŸ³";
                    statusIcon = "fa-microphone-slash";
                } else if (member.isSpeaking) {
                    statusClass = "status-speaker";
                    statusText = "æ­£åœ¨å‘è¨€";
                    statusIcon = "fa-volume-up";
                }
                
                const muteIcon = isActuallyMuted ? 'fa-microphone-slash' : 'fa-microphone';
                const muteTitle = isActuallyMuted ? 'å–æ¶ˆé™éŸ³' : 'é™éŸ³';
                const muteBtnClass = isActuallyMuted ? 'mute-btn muted' : 'mute-btn';
                
                membersHTML += `
                    <div class="member-card ${isLocal ? 'local' : ''}">
                        <div class="avatar ${isLocal ? 'local' : 'remote'}" style="background: ${colors[colorIndex]}">
                            ${isLocal ? 'æˆ‘' : 'ç”¨æˆ·'}
                        </div>
                        <div class="member-info">
                            <div class="member-name">
                                ${isLocal ? 'æˆ‘ (æœ¬åœ°)' : `ç”¨æˆ· ${uid}`}
                            </div>
                            <div class="member-uid">UID: ${uid}</div>
                            <div class="member-status ${statusClass}">
                                <i class="fas ${statusIcon}"></i>
                                ${statusText}
                            </div>
                        </div>
                        <div class="member-actions">
                            <button class="action-btn ${muteBtnClass}" 
                                    onclick="toggleMemberMute('${uid}')" 
                                    title="${muteTitle}"
                                    ${isLocal ? 'disabled' : ''}>
                                <i class="fas ${muteIcon}"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            membersListDiv.innerHTML = membersHTML;
        }
        
        // åˆ‡æ¢æˆå‘˜é™éŸ³
        window.toggleMemberMute = function(uid) {
            const member = members.get(uid);
            if (!member) return;
            
            if (member.isLocal) {
                toggleMicrophone();
            } else {
                if (member.audioTrack) {
                    if (member.isMuted) {
                        member.audioTrack.play();
                    } else {
                        member.audioTrack.stop();
                    }
                    member.isMuted = !member.isMuted;
                    updateMembersDisplay();
                }
            }
        };
        
        // æ£€æµ‹éº¦å…‹é£æƒé™
        async function checkMicPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (e) {
                alert(`éº¦å…‹é£æƒé™æ£€æµ‹å¤±è´¥ï¼š${e.message}\nè¯·æ£€æŸ¥ï¼š1.æµè§ˆå™¨æƒé™ 2.éHTTPç¯å¢ƒï¼ˆéœ€HTTPS/localhostï¼‰`);
                console.error("éº¦å…‹é£æƒé™å¤±è´¥ï¼š", e);
                return false;
            }
        }
        
        // æ›´æ–°é€šè¯çŠ¶æ€æ˜¾ç¤º
        function updateCallStatus(status, message) {
            if (!callStatusDiv || !statusTextSpan) return;
            
            callStatusDiv.style.display = 'block';
            callStatusDiv.className = 'call-status';
            
            if (status === 'connecting') {
                statusTextSpan.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> ${message}`;
            } else if (status === 'connected') {
                callStatusDiv.classList.add('connected');
                statusTextSpan.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            } else if (status === 'disconnected') {
                callStatusDiv.classList.add('disconnected');
                statusTextSpan.innerHTML = `<i class="fas fa-times-circle"></i> ${message}`;
            } else if (status === 'error') {
                callStatusDiv.classList.add('disconnected');
                statusTextSpan.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            }
            
            if (status === 'connected' || status === 'error') {
                setTimeout(() => {
                    if (callStatusDiv && (callStatusDiv.classList.contains('connected') || 
                         callStatusDiv.classList.contains('disconnected'))) {
                        callStatusDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }
        
        // åˆ‡æ¢é€šè¯çŠ¶æ€
        async function toggleCall() {
            if (!callToggleBtn || !micToggleBtn) return;
            
            if (isInCall) {
                await leaveChannel();
            } else {
                await joinChannel();
            }
        }
        
        // åŠ å…¥é¢‘é“
        async function joinChannel() {
            if (!channelNameInput) {
                alert("æ— æ³•è·å–é¢‘é“è¾“å…¥æ¡†");
                return;
            }
            
            const channelName = channelNameInput.value.trim();
            if (!channelName) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é¢‘é“åï¼");
                return;
            }
            
            // æ£€æµ‹éº¦å…‹é£æƒé™
            const hasMicPerm = await checkMicPermission();
            if (!hasMicPerm) return;
            
            updateCallStatus('connecting', 'æ­£åœ¨åŠ å…¥é¢‘é“...');
            callToggleBtn.disabled = true;
            
            try {
                await initRtcClient();
                
                // åˆ›å»ºéº¦å…‹é£éŸ³é¢‘è½¨é“
                let audioTrack = await createMicrophoneAudioTrack();
                
                if (!audioTrack || !audioTrack.play) {
                    throw new Error("éŸ³é¢‘è½¨é“åˆ›å»ºå¤±è´¥ï¼šéæœ‰æ•ˆè½¨é“å®ä¾‹");
                }
                
                localAudioTrack = audioTrack;
                console.log(`éº¦å…‹é£éŸ³é¢‘è½¨é“åˆ›å»ºæˆåŠŸ`);
                
                // è·å–ç”¨æˆ·è¾“å…¥çš„Token
                const userToken = tokenInput.value.trim();
                const token = userToken || null;
                
                // åŠ å…¥é¢‘é“
                const uid = await rtcClient.join(APP_ID, channelName, token);
                console.log(`åŠ å…¥é¢‘é“ã€${channelName}ã€‘æˆåŠŸï¼ŒUID: ${uid}`);
                
                // æ·»åŠ æœ¬åœ°æˆå‘˜åˆ°åˆ—è¡¨
                addMember(uid, true, localAudioTrack);
                updateMembersDisplay();
                
                // å‘å¸ƒéŸ³é¢‘
                if (!isPublished) {
                    await rtcClient.publish([localAudioTrack]);
                    isPublished = true;
                    console.log("æœ¬åœ°éŸ³é¢‘å‘å¸ƒæˆåŠŸ");
                    
                    // é»˜è®¤å…³é—­è¯ç­’
                    micTextSpan.textContent = 'å¼€å¯è¯ç­’';
                    micToggleBtn.classList.remove('muted');
                    micToggleBtn.querySelector('i').className = 'fas fa-microphone';
                    localAudioTrack.setEnabled(false);  // é»˜è®¤è®¾ç½®ä¸ºfalseï¼ˆå…³é—­ï¼‰
                    isMicrophoneMuted = true;  // é»˜è®¤è®¾ç½®ä¸ºtrueï¼ˆé™éŸ³ï¼‰
                    
                    const localMember = Array.from(members.values()).find(m => m.isLocal);
                    if (localMember) {
                        localMember.isMuted = true;  // é»˜è®¤è®¾ç½®ä¸ºtrueï¼ˆé™éŸ³ï¼‰
                        updateMembersDisplay();
                    }
                }
                
                // æ›´æ–°é€šè¯çŠ¶æ€
                isInCall = true;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                callToggleBtn.disabled = false;
                callToggleBtn.classList.add('in-call');
                callTextSpan.textContent = 'é€€å‡ºé€šè¯';
                callToggleBtn.querySelector('i').className = 'fas fa-phone-slash';
                
                // å¯ç”¨è¯ç­’æŒ‰é’®
                micToggleBtn.disabled = false;
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateCallStatus('connected', `å·²åŠ å…¥é¢‘é“ï¼š${channelName} | UIDï¼š${uid}`);
                
            } catch (e) {
                console.error("åŠ å…¥/å‘å¸ƒå¤±è´¥ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰ï¼š", {
                    message: e.message,
                    code: e.code,
                    stack: e.stack
                });
                
                let errMsg = `åŠ å…¥é€šè¯å¤±è´¥ï¼š${e.message}`;
                if (e.code === "INVALID_PARAMS") {
                    errMsg += "\nåŸå› ï¼šå‘å¸ƒçš„è½¨é“éæœ‰æ•ˆæœ¬åœ°è½¨é“ï¼ˆè½¨é“åˆ›å»ºå¤±è´¥/å‚æ•°æ ¼å¼é”™è¯¯ï¼‰";
                } else if (e.code === "CAN_NOT_GET_GATEWAY_SERVER") {
                    errMsg += "\nåŸå› ï¼šToken/é¢‘é“å/AppID ä¸åŒ¹é…ï¼Œæˆ–é‰´æƒæ¨¡å¼å†²çª";
                } else if (e.message.includes("permission")) {
                    errMsg += "\nåŸå› ï¼šéº¦å…‹é£æƒé™è¢«æ‹’ç»";
                } else if (e.message.includes("token")) {
                    errMsg += "\nåŸå› ï¼šTokenæ— æ•ˆæˆ–è¿‡æœŸï¼Œè¯·æ£€æŸ¥å¹¶é‡æ–°è¾“å…¥";
                }
                
                callToggleBtn.disabled = false;
                isInCall = false;
                
                updateCallStatus('error', errMsg);
                
                if (localAudioTrack) {
                    localAudioTrack.close();
                    localAudioTrack = null;
                }
                isPublished = false;
            }
        }
        
        // åˆ‡æ¢éº¦å…‹é£å¼€å…³
        function toggleMicrophone() {
            if (!localAudioTrack || !micToggleBtn || !micTextSpan) return;
            
            if (isMicrophoneMuted) {
                localAudioTrack.setEnabled(true);
                micToggleBtn.querySelector('i').className = 'fas fa-microphone-slash';
                micTextSpan.textContent = 'å…³é—­è¯ç­’';
                micToggleBtn.classList.add('muted');
                console.log("éº¦å…‹é£å·²å¼€å¯");
                
                const localMember = Array.from(members.values()).find(m => m.isLocal);
                if (localMember) {
                    localMember.isMuted = false;
                }
            } else {
                localAudioTrack.setEnabled(false);
                micToggleBtn.querySelector('i').className = 'fas fa-microphone';
                micTextSpan.textContent = 'å¼€å¯è¯ç­’';
                micToggleBtn.classList.remove('muted');
                console.log("éº¦å…‹é£å·²å…³é—­");
                
                const localMember = Array.from(members.values()).find(m => m.isLocal);
                if (localMember) {
                    localMember.isMuted = true;
                }
            }
            
            isMicrophoneMuted = !isMicrophoneMuted;
            updateMembersDisplay();
        }
        
        // é€€å‡ºé¢‘é“
        async function leaveChannel() {
            try {
                updateCallStatus('connecting', 'æ­£åœ¨ç¦»å¼€é¢‘é“...');
                callToggleBtn.disabled = true;
                
                if (localAudioTrack) {
                    localAudioTrack.close();
                    localAudioTrack = null;
                    console.log("æœ¬åœ°éŸ³é¢‘è½¨é“å·²é‡Šæ”¾");
                }
                
                if (rtcClient) {
                    await rtcClient.leave();
                    rtcClient = null;
                    console.log("å·²é€€å‡ºé¢‘é“");
                }
                
                members.clear();
                updateMembersDisplay();
                
                isPublished = false;
                isMicrophoneMuted = true;
                isInCall = false;
                
                callToggleBtn.disabled = false;
                callToggleBtn.classList.remove('in-call');
                callTextSpan.textContent = 'åŠ å…¥é€šè¯';
                callToggleBtn.querySelector('i').className = 'fas fa-phone-alt';
                
                micToggleBtn.disabled = true;
                micToggleBtn.querySelector('i').className = 'fas fa-microphone';
                micTextSpan.textContent = 'å¼€å¯è¯ç­’';
                micToggleBtn.classList.remove('muted');
                
                updateCallStatus('disconnected', 'å·²é€€å‡ºé€šè¯');
                
            } catch (leaveErr) {
                console.error("é€€å‡ºé¢‘é“å¤±è´¥ï¼š", leaveErr);
                updateCallStatus('error', `é€€å‡ºé€šè¯å¤±è´¥ï¼š${leaveErr.message}`);
                callToggleBtn.disabled = false;
            }
        }
        
        // è®©å‡½æ•°åœ¨å…¨å±€å¯ç”¨
        window.toggleCall = toggleCall;
        window.toggleMicrophone = toggleMicrophone;
    </script>
</body>
</html>